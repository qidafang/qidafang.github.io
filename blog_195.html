<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>思而勤工作室</title>
	<link rel="stylesheet" href="blog.css">
</head>
<body>
<div id="container">
<a href="index.html">回目录</a>
<h1>mybatis的意义</h1>
<div><p><strong>一图流：mybatis的立身之本</strong></p>

<p><img alt="" src="http://img.zidafone.com/427studio/b74f16d8-39c7-449a-ad8e-e1524494f3a5.png" style="height:357px; width:583px" /></p>

<p>当你需要持久层的类的时候，只需要编写持久层的接口，规定接口签名，再去sql文件里写sql。<br />
mybatis会自动生成持久层的实现类，其方法签名与你接口的签名一致，而方法体基于你写的sql语句。</p>

<p>这<strong>实现了java与sql的解耦，mybatis把这两种不同的语言粘合得天衣无缝，让java写的方法签名和基于sql的方法体完美配合</strong>。<br />
方法参数：java要写，sql也要写，而且要保证名称、输入参数类型一致。<br />
返回值：java要写，sql也要写，而且要保证返回值类型一致。<br />
方法体：java不用写，sql需要写，其实就是写sql语句。<br />
方法调用：调用java的方法，mybatis默默地做了jdbc啊类型转换啊sql拼接啊参数设置啊这些琐事，java方法返回的是最正常的java对象。</p>

<p>程序员写的业务代码，地位在mybatis之上，程序员写的sql配置文件，地位在mybatis之下，mybatis接管的是低层控制流：&ldquo;老大，这些琐事交给我了，你只需要定义一下sql就哦了&rdquo;。</p>

<p><strong>好处：</strong></p>

<p>1.SQL外部化，通过模板语言来渲染，这好处用string拼过sql的都懂。<br />
2.好用的语法，比如where子句没内容，光一个where不对，或者where之后劈面来一个and也不对，这些拼sql的烦心事mybatis都能处理。<br />
3.包括in子句的括号和逗号啊，set子句的最后一个逗号啊，where子句分页时既被查记录语句使用又被查总数语句使用的重复问题啊，都能方便地解决。<br />
4.参数的自动类型转换，从对象或map上直接绑定到sql的占位符上，还是没有sql注入风险的。<br />
5.结果集的自动类型转换，从resultset直接转为指定的对象类型。<br />
6.而且参数和结果集都支持复杂的对象层级关系，比如连表查询，结果直接产生一个主对象和其引用的对象们。</p>

<p>回想一下，用纯jdbc写查询语句的情况：<br />
1.用jdbc语法写关于驱动、连接、statement的那点事儿。<br />
2.准备一个空的list。<br />
3.根据参数，拼sql的where部分，要注意没有查询条件，或者第一个查询条件不使用的问题，一般用个1=1占位。<br />
4.计算参数在拼出来的sql中的顺序下标，为了防止sql注入，不能直写到sql里，算下标是个烦人的事情。<br />
5.将参数设置到相应的下标位置。<br />
6.进行查询，获得resultset。<br />
7.遍历结果，根据列的顺序获取值，在循环体中new一个实体，依次将各个列的值设给实体的属性，这需要做类型转换。如果是联表查询，还需要建更多的实体，并设置实体关系。<br />
8.循环体中设值结束之后，把实体添加到list中，循环结束时，全部工作完成。<br />
9.当然别忘了resultset/statement/connection的安全关闭的可怕语句。</p>

<p>其中开头结尾的第1步和第9步，可以抽出去用工具类包括连接池什么的统一，暂时不管它们。<br />
1)第3步的拼sql是非常让人讨厌的事情，长长的拼接语句和判断语句彼此分隔，还要注意少没少空格啊这种破事，如果知道用stringbuilder就比用string的写法更繁琐一些。<br />
2)第4-5步的参数列表，可能与第2步共用判断体，生成一个list然后toarray，这时候如果里面有in啊between啊之类的要更烦一点。<br />
3)第7步的查询结果处理，要留心下标以1开始的问题，还要为每个字段取一下值再给实体setXXX一下，如果字段多了，光这部分编写就会让人不耐烦。</p>

<p>你忍无可忍想到要封装，主要解决的就是上面三个问题：<strong>1)SQL构建；2)参数转型与赋值；3)结果转型与赋值</strong><br />
SQL构建当然用模板语言比较爽，起码不用手动连接字符串了，还能用模板语言的判断标签。<br />
参数转型这个容易，定义一个java类型与数据库类型的对应关系就行了。<br />
参数赋值，需要在编写SQL的时候用占位符，解读SQL的时候一是把占位符换成?，二是根据占位符从参数对象里取值设到参数list里。<br />
结果转型也容易。<br />
结果赋值，最好返回的列名本身就是属性名，用反射直接调用setter设进去。如果涉及到嵌套则要复杂一点。<br />
如果你觉得反射也太麻烦，干脆参数和结果都用map算了，那就是放弃了强类型的好处，即实体有哪些字段，每个字段是什么类型，变得不确定了，IDE没法在编程时帮助你检查。</p>

<p>当你完成了上面这些，你的山寨版mybatis就出炉了。</p>

<p><strong>参考</strong>：<a href="http://mybatis.github.io/mybatis-3/zh/index.html">官方的中文文档</a>足够了</p>
</div>
</div>
</body>
</html>