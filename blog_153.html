<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>思而勤工作室</title>
	<link rel="stylesheet" href="blog.css">
</head>
<body>
<div id="container">
<a href="index.html">回目录</a>
<h1>思而勤系统的安全控制部分</h1>
<div><p><strong>背景：</strong><br />
思而勤的多个产品，目前是在同一个项目下开发，即思而勤主干项目。<br />
主干项目中，逻辑上分为多个项目，如CMS系统，SHOP系统，CRM系统等。</p>

<p><strong>角色定义：</strong><br />
超级管理员<br />
前台用户<br />
后台用户<span style="color:#FF0000">//只有拥有该角色的用户才能在后台登录</span><br />
CMS后台用户甲<br />
CMS后台用户乙<br />
SHOP后台用户丙<br />
&hellip;&hellip;</p>

<p><strong>权限定义：</strong><br />
前台权限XX<br />
CMS后台登录权限<br />
CMS后台权限XX<br />
CMS后台权限YY<br />
SHOP后台登录权限<br />
SHOP后台权限ZZ<br />
&hellip;&hellip;</p>

<p><strong>用户、角色和权限的关系：</strong><br />
1.任何需要在后台登录的用户，必须拥有【后台用户】角色<br />
2.如果该用户不是超级管理员，则必须再为他指定一个【XX项目后台用户XX】角色，如：CMS文章添加员<br />
3.XX项目后台用户XX角色，必须为其分配XX项目后台登录权限，如：CMS文章添加员，必须拥有CMS后台登录权限<br />
4.拥有了XX项目后台登录权限后，才可能为其分配XX项目的XX权限，如：CMS文章添加员，在被分配了CMS后台登录权限后，可以再被分配一个CMS添加文章权限<br />
5.当然，想拥有添加/修改/删除文章权限，首先要有查看文章权限，逻辑上是这样，代码暂时未实现<br />
6.总结：比如【小勤】是负责为CMS系统添加文章的人，<br />
他应该拥有的角色是：1)后台用户；2)CMS文章添加员；<br />
他应该拥有的权限是：1)CMS后台登录权限；2)CMS查看文章权限；3)CMS添加文章权限。</p>

<p><strong>关于命名的约定：</strong><br />
角色：大写字母开头，驼峰命名法，如果是项目角色，以项目名开头，如：Admin/Manager/CmsArticalAdder<br />
权限：<br />
0)后台登录权限为admin:项目名:login，如admin:cms:login<br />
1)后台权限以admin:项目名:实体名:操作名的方式编写，实体名小写字母开头驼峰命名法命名，其他部分一律小写字母，如：admin:cms:artical:add。<br />
2)前台权限以member:项目名:实体名:操作名的方式编写，如member:cms:artical:add<br />
3)增删改查的操作名依次为add/delete/edit/view，添加其他操作名，尽量选用单个单词</p>

<p><strong>待确定的未完部分：</strong><br />
1)前台用户角色的命名，大概就是Member横跨多个项目（类比Manager横跨后台多个项目），然后具体的项目需要角色再添加，如ShopSaler之类</p>

<p><strong>技术上的实现：</strong><br />
1)shiro配置文件里把/admin开头的都要求有后台用户角色<br />
2)后台菜单显示的时候根据XX项目后台登录权限决定菜单组显示，根据XX项目XX功能权限决定菜单项显示<br />
例：小勤能登录后台，是因为小勤有【后台用户】角色，登录后能看到CMS总菜单，是因为有【CMS后台登录权限】（来自【CMS文章添加员角色】，下同），展开CMS总菜单能看到文章管理菜单项，是因为有【CMS查看文章权限】，在文章一览页面能看到添加文章按钮并能点进去操作，是因为有【CMS添加文章权限】<br />
3)对权限的控制，在jsp和controller写shiro的标签/注解，前者用于控制显示与否，后者用于真正保护功能，防止恶意用户自己写url来操作</p>

<p><strong>关于数据权限：</strong><br />
1)功能权限外的数据权限，目前没做，实现方法如下：让删、改操作都依赖查询操作，并在查询语句上连表实现数据权限，让登录用户的id进入查询语句来筛选，这样他看到的只是自己的数据，能删/改的数据是能看到的数据的子集。<br />
2)对善良的用户，页面上看不到权限外的数据，不存在删/改操作的可能；对恶意的用户，可以伪造请求操作，所以后台要对删/改的目标，进行查询，如果查不到（被sql中的用户id过滤了），就判定为恶意用户，用户id记录日志。<br />
3)由于新增操作会自动将操作者id记录到表的添加人字段里，至此增删改查的数据权限就完整了。</p>

<p><strong>关于安全：</strong><br />
1)sql注入，由于排序字段只能用${}的方式嵌入，所以后台规定白名单，前台传的排序字段只有在白名单中才可用<br />
2)xss攻击，目前还没做，比如恶意用户可以在添加博客时在博客内容中写脚本，应该在后台进行过滤<br />
3)csrf攻击，目前也没做，可以做成点击删除按钮时发一个ajax请求，附带一个token到页面，点击确定删除时，将token也发到后台，后台确定无误才真正删除；增、改则可以在form中加隐藏域放token，提交到后台检查<br />
（以上两个漏洞这么写出来没关系吧&hellip;&hellip;）</p>
</div>
</div>
</body>
</html>