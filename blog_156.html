<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>思而勤工作室</title>
	<link rel="stylesheet" href="blog.css">
</head>
<body>
<div id="container">
<a href="index.html">回目录</a>
<h1>shiro那点事儿</h1>
<div><p>昨天晚上有点疲劳，写<a href="http://427studio.net/blog/1/155">shiro的博客</a>略显敷衍，今天趁早起详细聊聊。<br />
1.<br />
shiro是什么？安全框架。<br />
安全的含义是：能阻拦不适当的操作。<br />
框架的含义是：拥有部分控制流的主导权，用户的自定义扩展将在其控制流内运转。<br />
2.<br />
阻拦不适当的操作。<br />
首先，怎样分辨一个操作是不是适当的。<br />
其次，当操作不适当，该怎么办。<br />
3.<br />
分辨适当操作，最常见的是基于登录用户，即&ldquo;某个人&rdquo;&ldquo;有权&rdquo;做&ldquo;某个事&rdquo;。<br />
4.<br />
所谓某个人，是指与系统连接的某个客户端，如浏览器啊，api调用者啊，爬虫啊。<br />
系统说：我凭什么相信你是你？拿证据来。<br />
客户端说：我有证据，我的证据是我知道密码。<br />
于是，最基本的&ldquo;某个人证明他是他&rdquo;的方法，称为登录。<br />
&ldquo;检查某个人确实是他自称的那个人&rdquo;这件事，称为校验。<br />
5.<br />
登录最基本的信息传递，是用户名和密码。（验证码和记住我是锦上添花，暂时不赘）<br />
由于数据库可能泄露的原因，现在系统都存放密文密码而不是明文密码。<br />
因为简单的md5加密容易被破解，一旦数据库泄露了，加密相当于没加密，所以加密采用加盐的方法，并重复加密N次。<br />
数据库中储存：用户名、密文密码和盐；程序中储存：加密方法和迭代次数；用户自己知道：明文密码。<br />
这样即使数据库和程序都泄露了，坏人也无法反推只有用户自己知道的明文密码。<br />
而登录校验的方法是：程序根据用户输入的用户名，去数据库中获得盐和密文密码，根据盐和用户输入的明文密码，用程序中定义的加密方法和迭代次数，算出一个新的密文，把这个新的密文，与数据库中存的密文密码比对，如果一致，证明用户名和密码输入正确，登录校验成功。反之失败。<br />
6.<br />
如果你不是你所自称的那个人，有两种可能，一是你一时马虎密码输错了，二是你确实是坏人。<br />
判断方法就是&ldquo;密码连续输入错误则冻结&rdquo;，因为好人可能输错密码，但在输错密码后的谨慎状态下，不太可能出现接二连三输错的情况。<br />
所谓冻结，就是系统中存放一个用户状态：已冻结，登录时先检查用户是否已冻结。<br />
7.<br />
OK。假设你确实登录成功了，你是你自称的那个人，那你有没有权利做这件事呢？<br />
&ldquo;做这件事&rdquo;就是&ldquo;对某个资源的某种处置&rdquo;，所以你希望的权利，就是&ldquo;对某个资源的某种处置权&rdquo;。<br />
8.<br />
&ldquo;资源&rdquo;，一般指某种名词，比如订单，客户，博客文章，对应的编程元素，很可能是数据库的一张表，实体层的一个类定义。<br />
名词当然要有属性，比如一个球员有速度和力量两个属性，属性称为状态，对应的就是表的某个字段，类的某个属性。<br />
属性当然也可能是另一个资源，比如一个球员的俱乐部属性，今天在利物浦，明天去到了曼联（不太可能），利物浦和曼联是两个俱乐部实体，在编程上就体现为数据库的外键，类中的引用。<br />
对资源的处置，指的就是使资源的某个普通属性（如速度）或某个引用属性（如俱乐部）产生变化。<br />
有没有这种权利，就要考察是要对哪个资源，进行哪种操作。<br />
比如一个没登录的游客，看别人的博客是允许的，但删除别人的博客就肯定不行。已登录的游客，删自己的博客是允许的，但删别人的博客就还是不行。<br />
所以要限定两个方面：一是可不可以对某类型的资源进行某种操作，比如删博客，未登录用户不可以，已登录用户可以。<br />
二是对某个具体的资源有没有权利，是你的你可以删，别人的你不能删。<br />
先看第一点。<br />
9.<br />
对某类型资源的某种操作，是比较细粒度的点了，可以用一个权限来对应，不同的人，有没有这个操作权，就看他有没有这个权限。<br />
现实中分配权限，一般不是看某个具体的人，而是看这个人的身份，具有相同身份的人，他们的权限就相同，身份在系统中就称为角色。<br />
每个用户，都对应着一组角色（多对多），每个角色，又对应着一组权限（多对多），通过这个中转，就可以知道每个用户对应哪些权限了。<br />
也就知道&ldquo;对某个类型的资源的某种操作权&rdquo;，你到底有没有了。<br />
10.<br />
如果有这个权利，好说。如果没有呢？<br />
首先要让他看不到进行这个操作的可能性，否则如果误认为自己可以操作，然后才发现不能，会让人沮丧。<br />
用《道德经》的话说，叫&ldquo;不见可欲，使民心不乱&rdquo;。<br />
说白了，就是在界面上不显示，菜单啊，按钮啊。<br />
其次，如果有坏人想出自己伪造个请求，怎么办？<br />
这就需要在服务端控制，某个请求要删除某个用户？检查下是谁干的，他有没有权力这么干。一看没权力，拒绝。<br />
浏览器端隐藏，服务器端限制，两者缺一不可。<br />
11.<br />
服务器端限制，可以在每个具体的点（如响应请求的方法）上加，但这样一个个加，有点麻烦。<br />
简化的方法是，为某些类似的操作，进行统一的限制。<br />
这就是拦截器的价值。<br />
当然了，&ldquo;某些类似的操作&rdquo;具体是什么范围？这就需要通配符来定义。<br />
这就是约定的价值。<br />
约定是一种软的约束，你大可以无视它，但之后的苦恼你要自己负责。<br />
12.<br />
拦截器的用处是，当进行&ldquo;某些类似的操作&rdquo;其中之一时，由定义的拦截器进行把关。<br />
系统认为这个操作是不是适当的，就由拦截器说了算。<br />
比如系统认为这个操作需要某种权限，而登录用户没有这权限，那就是不适当的操作。<br />
权限拦截器是拦截器中的一种，用户、角色、权限的配置，对资源需要权限的配置，正是在权限拦截器里产生效果的。<br />
13.<br />
上面说了，对用户是不是他本人的检查，称为校验；上面忘了说，对用户有哪些权限的判断，称为授权。<br />
上面都没说，由于校验和授权在各个业务场景的需求千差万别，所以要由用户自己来决定。<br />
具体的，就是用户自己写回调函数，函数的输入和输出类型都是事先定义好的，用户来实现函数体。<br />
Java里函数不是一等对象，所以需要类承载，就是赫赫有名的策略模式，用类承载的另一个好处是，函数体需要使用另一个对象的方法，可以将这个对象注入进来。<br />
在Shiro中，这个策略类就是XXRealm，你在其中定义校验函数、授权函数、加密方法，然后把它配置给shiro，在shiro中运转。<br />
14.<br />
这就是框架与扩展点的关系，框架主导了控制流，但具体细节的行为可以由你来决定，你可以决定的点，就是扩展点。<br />
所谓&ldquo;对修改关闭，对扩展开放&rdquo;（开-闭原则），就是控制流一百年不能变（对修改关闭），但是细节上就黑猫白猫了（对扩展开放），是为抓大放小。<br />
15.<br />
Shiro中最常用的扩展点，除了Realm还有Token。<br />
Realm承载的是动词，定义策略行为；Token承载的是名词，定义登录表单项。<br />
比如要添加验证码的登录表单项，就要自己定义一个Token，这有点像Struts1的ActionForm。<br />
16.<br />
Shiro中最重要的扩展点，是拦截器，常称为XXFilter，之所以叫拦截器而不是过滤器（Filter的本意），是因为拦截两字的门神含义，我猜的。<br />
拦截器，实际决定了一个请求到底会不会放行，如果你乐意，尽可以展开想象，比如请求的任何一个参数值是&quot;427studio&quot;就放行，管他的登录没有，有没权限，我就乐意这么放行，管得着么。<br />
运用之妙，存乎一心。<br />
17.<br />
不论是Realm，Token，Filter，Shiro都给出了大量现有的实现。<br />
好的框架往往是这样，给你留出扩展点，又亲自实现这些扩展点，这些具体实现，用不用在你，如果用，那你就省事了。<br />
根据帕累托定律，80%的场景只有20%的变化，所以框架给你实现，至于剩下那可能性多达80%、总数量又只有20%的场景，框架就放权给你了。它相信你有能力实现。<br />
18.<br />
同样是定义策略，Filter和Realm的区别是前者更靠前，在表现层逻辑之前，而后者则更靠后，连接着业务层甚至持久层。<br />
19.<br />
很重要的类：SecurityUtils，提供了获得另两个很重要的类Subject和SecurityManager，方便程序员编程。<br />
拿到Subject你就牛了，基本想干啥就干啥，编程式判断角色呀，判断权限呀，登录登出呀，只有想不到没有做不到。<br />
20.<br />
最后还是推荐<a href="http://jinnianshilongnian.iteye.com/blog/2018398">今年是龙年的教程</a>，<a href="http://jinnianshilongnian.iteye.com/">这人的博客</a>都值得认真学习。<br />
至此凑齐了20个小节，收笔。</p>
</div>
</div>
</body>
</html>